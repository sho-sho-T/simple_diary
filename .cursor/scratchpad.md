# このファイルの説明(編集不可)
このスクラッチパッドファイルは、タスク管理および実装計画のためのものです。
取り組むタスクにおける作業計画をチェックボックス形式で記述します。

- [X] = 完了 (100% 完了、検証済み)
- [-] = 進行中 (積極的に作業中)
- [ ] = 計画 (未開始)
- [!] = ブロック (依存関係あり)
- [?] = レビューが必要 (検証が必要)

# 作業計画(編集可)

ステータス: [Active]
確信度: [95%]
最終更新日: 2025-03-06

## 日記アプリケーション実装計画

### Phase 1: バックエンド基盤構築
[ID-001] データベース準備
- [X] Prismaスキーマの最終確認
  - 既存のスキーマの整合性と関連性を確認
  - 必要に応じてインデックスの追加（パフォーマンス最適化のため）
  - 外部キー制約の確認（データ整合性のため）
- [X] マイグレーションコマンド実行 (`npx prisma db push`)
  - 実行前にデータベース接続文字列(.env)の確認
  - マイグレーション実行とエラーハンドリング
  - 必要に応じて代替コマンド（`migrate dev --create-only` + `migrate deploy`）の準備
- [X] データベース接続のテスト
  - `prisma.ts`を使用した接続テストの実装
  - 簡易的なクエリテストの実行
  - エラー発生時のログ記録と対応策の準備

[ID-002] APIエンドポイント実装: 日記エントリー関連
- [X] データアクセス層の実装 (`app/api/diary/_lib/`)
  - Server Componentsで使用するデータフェッチ関数の実装
  - データ操作の処理をまとめたモジュールの作成
  - `server-only`パッケージの活用
- [X] `GET /api/diary/route.ts` - 全日記エントリー取得
  - Server Actionsでの実装（認証付き）
  - ページネーションとフィルタリングのサポート
  - 日付でのソート機能
- [X] `GET /api/diary/[date]/route.ts` - 特定日付の日記エントリー取得
  - 動的ルートパラメータを使用した実装
  - 存在しない場合のエラーハンドリング
  - レスポンスのキャッシュ設定 (Static vs Dynamic)
- [X] `POST /api/diary/route.ts` - 日記エントリー作成
  - Zodを使用したバリデーション
  - Server Actionsでのデータ保存
  - 成功/エラー時のフィードバック
- [X] `PUT /api/diary/[id]/route.ts` - 日記エントリー更新
  - 既存エントリーの検証
  - 部分更新のサポート
  - 楽観的更新のサポート
- [X] `DELETE /api/diary/[id]/route.ts` - 日記エントリー削除
  - 削除前の確認
  - 関連データ（タグ関連）の処理
  - ソフトデリートの検討
- [X] `GET /api/diary/similar-dates/route.ts` - 過去の同日の日記取得
  - 日付計算ロジックの実装
  - 効率的なクエリの構築
  - レスポンスのキャッシュ設定

[ID-003] APIエンドポイント実装: タグ関連
- [X] データアクセス層の実装 (`app/api/tags/_lib/`)
  - タグ操作のためのデータアクセス関数の作成
  - 再利用可能なクエリの実装
  - `server-only`パッケージの活用
- [X] `GET /api/tags/route.ts` - タグ一覧取得
  - ユーザー別タグ一覧の取得
  - 使用頻度や作成日でのソートオプション
  - レスポンスのキャッシュ設定
- [X] `POST /api/tags/route.ts` - タグ作成
  - 名前と色情報のバリデーション
  - 重複チェック（ユーザーごとにユニーク）
  - エラーハンドリング
- [X] `PUT /api/tags/[id]/route.ts` - タグ更新
  - 存在確認と所有権確認
  - 部分更新のサポート
  - タグ使用中の場合の特別処理
- [X] `DELETE /api/tags/[id]/route.ts` - タグ削除（未使用タグのみ）
  - 使用中のタグかどうかの確認ロジック
  - 削除条件のバリデーション
  - カスケード削除の回避

### Phase 2: フロントエンド実装
[ID-004] 共通UIコンポーネント構築
- [X] レイアウトとナビゲーション
- [X] 日記エントリーカードコンポーネント
- [X] タグ表示・選択コンポーネント
- [X] 感情スタンプ選択コンポーネント
- [X] 基本的なUIライブラリのセットアップ (shadcn/ui)

[ID-005] マークダウンエディタ実装
- [ ] リアルタイムプレビュー機能
- [ ] ツールバーと基本的なマークダウン操作
- [ ] react-markdownの統合

[ID-006] カレンダーと日記表示画面
- [ ] 月間カレンダーの実装 (react-day-picker)
- [ ] 日付選択時の日記表示
- [ ] 過去の同日日記表示機能

[ID-007] 日記作成・編集フォーム
- [ ] 日記テキスト入力部分
- [ ] タグ選択・作成機能
- [ ] 感情スタンプ選択機能
- [ ] Zodバリデーション統合

### Phase 3: 認証と権限管理
[ID-008] Next Auth認証統合
- [ ] ログイン/ログアウト機能
- [ ] セッション管理
- [ ] 認証状態によるUI適応
- [ ] 保護されたルートの設定

### Phase 4: 追加機能実装
[ID-009] タグ検索・フィルタリング機能
- [ ] タグベースの日記フィルタリング
- [ ] タグクラウド/タグリスト表示
- [ ] タグ管理インターフェース

[ID-010] 感情スタンプの可視化
- [ ] 感情スタンプの時系列分析
- [ ] カレンダーでの感情表示

### Phase 5: 最適化とテスト
[ID-011] パフォーマンス最適化
- [ ] サーバーコンポーネントとクライアントコンポーネントの適切な使い分け
- [ ] データフェッチ最適化
- [ ] レンダリング戦略の改善

[ID-012] テストとバグ修正
- [ ] 単体テスト作成
- [ ] E2Eテスト作成
- [ ] エッジケースの検証

## 実装方法詳細（Next.jsベストプラクティス準拠）

### サーバーコンポーネントとクライアントコンポーネントの使い分け
- データフェッチはサーバーコンポーネントで行う
- ユーザーインタラクションが必要な部分のみクライアントコンポーネントを使用
- コンポジションパターンを活用し、サーバーコンポーネントをクライアントコンポーネントに渡す

### データフェッチ層の設計
- データフェッチ処理を`_lib`ディレクトリに集約
- 処理の再利用性とコロケーションのバランスを確保
- `server-only`パッケージによるクライアントでの使用防止

### API実装のアプローチ
- Route Handlersとともに、Server Actionsを活用
- 細粒度のREST API設計を採用
- レスポンスの適切なキャッシュ設定

### エラーハンドリング
- サーバーコンポーネント: `error.tsx`でのエラーUI定義
- ServerActions: 予測可能なエラーは戻り値で表現
- フロントエンド: Toastなどを使用したユーザーフレンドリーなエラー表示

### セキュリティと認証
- 認証状態の確認と適切なエラーレスポンス
- URLベースの認可とデータアクセスベースの認可の両方を実装
- CSRF対策の実装

## 技術的な考慮事項と注意点

### データベース関連
- Prismaスキーマ変更後は必ずマイグレーションコマンドを実行すること
- 推奨コマンド: `npx prisma db push` または `npx prisma migrate dev --name xxx`
- エラー発生時は `npx prisma migrate dev --create-only` と `npx prisma migrate deploy` の組み合わせを試す

### 実装ガイドライン
- バリデーション: Zodを使用
- エラーハンドリング: グローバルエラーハンドリング
- パフォーマンス: サーバーコンポーネントでデータフェッチを行う
- レスポンシブデザイン: モバイルファースト
- shadcn/uiコンポーネントを活用

### 制約条件
- タグ削除時、使用中のタグは削除不可
- 日記は日付ごとに1エントリーのみ
- エラーケースの適切なハンドリング

# 緊急バグ修正タスク

ステータス: [Active]
確信度: [95%]
最終更新日: 2024-06-03

## エラー詳細
```
You cannot use different slug names for the same dynamic path ('date' !== 'id').
```

## 問題分析
Next.jsのAPI Routes設計において、同じパスパターンに対して異なるスラグ名を使用することはできません。現在の実装では：

1. `/api/diary/[date]/route.ts` - 特定日付の日記エントリー取得
2. `/api/diary/[id]/route.ts` - 日記エントリーの更新・削除

これらは同じパスパターン（`/api/diary/[パラメータ]`）に異なるスラグ名（`date`と`id`）を使用しているため、Next.jsのルーティングエンジンで競合が発生しています。

## 解決策候補

[ID-013] APIルーティング競合の解決
- [X] 異なるパスパターンを使用するようにルートを再設計
  - 案1: 日付ベースのルートを `/api/diary/by-date/[date]` に変更
  - 案2: ID ベースのルートを `/api/diary/by-id/[id]` に変更
  - 案3: 日付ベースのルートは日付のフォーマットを強制して一般的なIDと重複しないようにする（例: `YYYY-MM-DD`形式）
- [X] ルートファイルの移動と内容の調整
  - 影響するファイルの特定とバックアップ
  - 新しいディレクトリ構造の作成
  - ルートハンドラとサービス関数の接続の更新
- [X] リファクタリング後のテスト
  - 各エンドポイントのテスト
  - エラーケースのテスト
  - 期待通りのレスポンスが返されることの確認

## 技術的考慮事項
- Next.jsのルーティングルールに従って実装する
- memories.mdに記録されているAPIベストプラクティスを適用する
- リファクタリングにおいてはサービス層の実装は変更せず、ルートハンドラのみを変更する

## 優先度と影響範囲
- 優先度: 高（アプリケーションのビルドに影響するバグ）
- 影響範囲: 限定的（API実装の一部のみに影響）
- 対応工数見積: 約1時間（確認とテスト含む）

## 実装計画
1. 日付ベースのルートを `/api/diary/by-date/[date]` に変更する（案1を採用）✅
2. 必要なディレクトリ構造を作成し、ファイルを移動 ✅
3. インポートパスなど、必要に応じてコードを調整 ✅
4. 各エンドポイントのテストを実行 ✅
5. スクラッチパッドを更新して進捗を記録 ✅

## 実装結果
- 日付ベースのルートを `/api/diary/by-date/[date]` に変更し、競合を解消
- 絶対パス（`@/`エイリアス）を使用してインポートパスを修正
- 古いルートファイルとディレクトリを削除
- バグが解決し、アプリケーションが正常にビルドされるようになった