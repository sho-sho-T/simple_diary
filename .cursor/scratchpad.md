# このファイルの説明(編集不可)
このスクラッチパッドファイルは、タスク管理および実装計画のためのものです。
取り組むタスクにおける作業計画をチェックボックス形式で記述します。

- [X] = 完了 (100% 完了、検証済み)
- [-] = 進行中 (積極的に作業中)
- [ ] = 計画 (未開始)
- [!] = ブロック (依存関係あり)
- [?] = レビューが必要 (検証が必要)

# 作業計画(編集可)

ステータス: [Active]
確信度: [95%]
最終更新日: 2024-06-04

## 日記アプリケーション実装計画

### Phase 2: フロントエンド実装
[ID-004] 共通UIコンポーネント構築
- [X] レイアウトとナビゲーション
- [X] 日記エントリーカードコンポーネント
- [X] タグ表示・選択コンポーネント
- [X] 感情スタンプ選択コンポーネント
- [X] 基本的なUIライブラリのセットアップ (shadcn/ui)

[ID-005] 日記作成基本コンポーネント
- [ ] 日記入力フォームコンポーネント
  - [ ] テキストエリアコンポーネント（ひとこと日記用）
    - [ ] 最大500文字の入力制限実装
    - [ ] 文字数超過時のバリデーション
  - [ ] 文字数カウント機能
    - [ ] 残り文字数のリアルタイム表示
    - [ ] 残り文字数警告（50文字以下）
      - [ ] Lucideアイコン（AlertCircle）の表示
      - [ ] アイコンのツールチップ表示
  - [-] Server Actionsによる保存機能実装
    - [ ] 保存アクション実装
      - [ ] バリデーション処理
      - [ ] データベース保存処理
      - [ ] エラーハンドリング
    - [ ] ローディング状態の実装
      - [ ] ボタンのローディングスピナー
      - [ ] 保存中の入力無効化
    - [ ] Toast通知の実装（sonner使用）
      - [ ] 成功時: 「日記を保存しました」
      - [ ] エラー時: エラー内容の表示
      - [ ] バリデーションエラー時: 具体的なエラー内容
- [ ] 日付選択コンポーネント
  - [ ] カレンダーピッカー（react-day-picker）
  - [ ] 日付バリデーション（1日1エントリー制限）
    - [ ] 既存エントリーがある場合のToast通知
- [ ] StoryBookの実装
  - [ ] 各状態のストーリー作成
    - [ ] 通常状態
    - [ ] 文字数制限超過状態
    - [ ] 文字数警告状態（50文字以下）
    - [ ] 保存中状態
    - [ ] エラー状態
  - [ ] インタラクションテストの追加
    - [ ] 文字数制限のテスト
    - [ ] 文字数警告表示のテスト
    - [ ] 保存処理のテスト
    - [ ] エラーハンドリングのテスト

[ID-006] カレンダーと日記表示画面
- [ ] 月間カレンダーの実装 (react-day-picker)
- [ ] 日付選択時の日記表示
- [ ] 過去の同日日記表示機能

[ID-007] 日記作成・編集フォーム
- [ ] 日記テキスト入力部分
- [ ] タグ選択・作成機能
- [ ] 感情スタンプ選択機能
- [ ] Zodバリデーション統合

[ID-015] 日記一覧画面 Server Component 実装
- [X] ディレクトリ構造の整理
- [X] container.tsxをServer Componentに変更
  - [X] "use client"ディレクティブの削除
  - [X] React hooks（useState, useEffect等）の削除
  - [X] サーバー側データフェッチの実装
  - [X] エラーハンドリングの追加
- [X] presentation.tsxのClient Component化
  - [X] 状態管理（月選択、ページネーション）の実装
  - [X] フィルタリングロジックの実装
- [X] Server Actionsの実装
  - [X] actions.tsファイルの作成
  - [X] 将来的な拡張のための基本構造
- [X] ページコンポーネントの改善
  - [X] Suspenseを使用したローディング状態の表示

### Phase 3: 認証と権限管理
[ID-008] Next Auth認証統合
- [ ] ログイン/ログアウト機能
- [ ] セッション管理
- [ ] 認証状態によるUI適応
- [ ] 保護されたルートの設定

### Phase 4: 追加機能実装
[ID-009] タグ検索・フィルタリング機能
- [ ] タグベースの日記フィルタリング
- [ ] タグクラウド/タグリスト表示
- [ ] タグ管理インターフェース

[ID-010] 感情スタンプの可視化
- [ ] 感情スタンプの時系列分析
- [ ] カレンダーでの感情表示

### Phase 5: 最適化とテスト
[ID-011] パフォーマンス最適化
- [ ] サーバーコンポーネントとクライアントコンポーネントの適切な使い分け
- [ ] データフェッチ最適化
- [ ] レンダリング戦略の改善

[ID-012] テストとバグ修正
- [ ] 単体テスト作成
- [ ] E2Eテスト作成
- [ ] エッジケースの検証

[ID-014] StoryBookの実装
- [ ] UIコンポーネント用のStories作成
- [ ] レイアウトコンポーネント用のStories作成
- [ ] 機能コンポーネント用のStories作成
- [ ] StoryBook実行環境のカスタマイズ
- [ ] テスト連携の設定

## 実装方法詳細（Next.jsベストプラクティス準拠）

### サーバーコンポーネントとクライアントコンポーネントの使い分け
- データフェッチはサーバーコンポーネントで行う
- ユーザーインタラクションが必要な部分のみクライアントコンポーネントを使用
- コンポジションパターンを活用し、サーバーコンポーネントをクライアントコンポーネントに渡す

### データフェッチ層の設計
- データフェッチ処理を`_lib`ディレクトリに集約
- 処理の再利用性とコロケーションのバランスを確保
- `server-only`パッケージによるクライアントでの使用防止

### API実装のアプローチ
- Route Handlersとともに、Server Actionsを活用
- 細粒度のREST API設計を採用
- レスポンスの適切なキャッシュ設定

### エラーハンドリング
- サーバーコンポーネント: `error.tsx`でのエラーUI定義
- ServerActions: 予測可能なエラーは戻り値で表現
- フロントエンド: Toastなどを使用したユーザーフレンドリーなエラー表示

### セキュリティと認証
- 認証状態の確認と適切なエラーレスポンス
- URLベースの認可とデータアクセスベースの認可の両方を実装
- CSRF対策の実装

## 技術的な考慮事項と注意点

### データベース関連
- Prismaスキーマ変更後は必ずマイグレーションコマンドを実行すること
- 推奨コマンド: `npx prisma db push` または `npx prisma migrate dev --name xxx`
- エラー発生時は `npx prisma migrate dev --create-only` と `npx prisma migrate deploy` の組み合わせを試す

### 実装ガイドライン
- バリデーション: Zodを使用
- エラーハンドリング: グローバルエラーハンドリング
- パフォーマンス: サーバーコンポーネントでデータフェッチを行う
- レスポンシブデザイン: モバイルファースト
- shadcn/uiコンポーネントを活用

### 制約条件
- タグ削除時、使用中のタグは削除不可
- 日記は日付ごとに1エントリーのみ
- エラーケースの適切なハンドリング

## 技術的考慮事項

### コンポーネントタイプ別の対応
- サーバーコンポーネント: サーバーコンポーネントの場合、必要に応じてStoriesでクライアントコンポーネントとしてラップ
- クライアントコンポーネント: 'use client'ディレクティブがあるコンポーネントについては、そのままStoryBookで表示可能
- 状態管理が必要なコンポーネント: 必要なコンテキストプロバイダーをdecoratorsで提供

### 特殊なケース
- フォーム関連コンポーネント: react-hook-formとの連携を考慮したストーリー設計
- API依存コンポーネント: MSWなどを使用したモックAPIレスポンスの提供

### ドキュメント化
- コンポーネントのJSDocコメントを活用したドキュメント自動生成
- argTypesでの適切な説明とコントロール設定
- MDXファイルによる追加の使用方法ドキュメント作成

## 成功基準
- 全ての対象コンポーネントについてStoryBookストーリーが作成されている
- コンポーネントの主要な機能と状態がストーリーでカバーされている
- StoryBookが正常に起動し、すべてのストーリーが適切に表示される
- チーム内でStoryBookをコンポーネント開発とレビューに活用できる

## リスクと軽減策
- 一部の高度な機能コンポーネントでモックデータ作成が複雑になる可能性 → 段階的に実装し、最初はシンプルなケースから対応
- サーバーコンポーネントのStoryBook対応の複雑さ → 必要に応じてStoryBook専用のラッパーコンポーネントを作成
- ビルド時間の増加 → StoryBookの設定を最適化し、必要に応じてストーリーをカテゴリ別に分離

# 緊急バグ修正タスク

ステータス: [Active]
確信度: [95%]
最終更新日: 2024-06-03

## エラー詳細
```
You cannot use different slug names for the same dynamic path ('date' !== 'id').
```

## 問題分析
Next.jsのAPI Routes設計において、同じパスパターンに対して異なるスラグ名を使用することはできません。現在の実装では：

1. `/api/diary/[date]/route.ts` - 特定日付の日記エントリー取得
2. `/api/diary/[id]/route.ts` - 日記エントリーの更新・削除

これらは同じパスパターン（`/api/diary/[パラメータ]`）に異なるスラグ名（`date`と`id`）を使用しているため、Next.jsのルーティングエンジンで競合が発生しています。

## 解決策候補

[ID-013] APIルーティング競合の解決
- [X] 異なるパスパターンを使用するようにルートを再設計
  - 案1: 日付ベースのルートを `/api/diary/by-date/[date]` に変更
  - 案2: ID ベースのルートを `/api/diary/by-id/[id]` に変更
  - 案3: 日付ベースのルートは日付のフォーマットを強制して一般的なIDと重複しないようにする（例: `YYYY-MM-DD`形式）
- [X] ルートファイルの移動と内容の調整
  - 影響するファイルの特定とバックアップ
  - 新しいディレクトリ構造の作成
  - ルートハンドラとサービス関数の接続の更新
- [X] リファクタリング後のテスト
  - 各エンドポイントのテスト
  - エラーケースのテスト
  - 期待通りのレスポンスが返されることの確認

## 技術的考慮事項
- Next.jsのルーティングルールに従って実装する
- memories.mdに記録されているAPIベストプラクティスを適用する
- リファクタリングにおいてはサービス層の実装は変更せず、ルートハンドラのみを変更する

## 優先度と影響範囲
- 優先度: 高（アプリケーションのビルドに影響するバグ）
- 影響範囲: 限定的（API実装の一部のみに影響）
- 対応工数見積: 約1時間（確認とテスト含む）

## 実装計画
1. 日付ベースのルートを `/api/diary/by-date/[date]` に変更する（案1を採用）✅
2. 必要なディレクトリ構造を作成し、ファイルを移動 ✅
3. インポートパスなど、必要に応じてコードを調整 ✅
4. 各エンドポイントのテストを実行 ✅
5. スクラッチパッドを更新して進捗を記録 ✅

## 実装結果
- 日付ベースのルートを `/api/diary/by-date/[date]` に変更し、競合を解消
- 絶対パス（`@/`エイリアス）を使用してインポートパスを修正
- 古いルートファイルとディレクトリを削除
- バグが解決し、アプリケーションが正常にビルドされるようになった

# [ID-005] 日記作成基本コンポーネント実装計画

ステータス: [Planning]
確信度: [95%]
最終更新日: 2024-03-26

## 概要
日記作成の基本コンポーネントを実装する。Container/Presentationalパターンを採用し、日記のテキスト入力、文字数カウント、保存機能、日付選択機能を持つコンポーネントを作成する。

## ディレクトリ構造
```
types/
  diary/
    form.ts         # 日記フォーム関連の型定義
    validation.ts   # バリデーションスキーマ

components/
  features/
    diary/
      form/
        index.tsx        # エクスポート用ファイル
        container.tsx    # データとロジックを担当
        presentational.tsx  # UI表示を担当
        text-area.tsx     # テキストエリアコンポーネント
        character-counter.tsx  # 文字数カウントコンポーネント
        date-picker.tsx  # 日付選択コンポーネント
        actions.ts       # Server Actions
```

## 実装ステップ

### 1. 型定義とバリデーション
- [ ] `types/diary/form.ts`の作成
  - [ ] フォーム入力値の型定義
  - [ ] コンポーネント間で共有するProps型の定義
- [ ] `types/diary/validation.ts`の作成
  - [ ] Zodによるバリデーションスキーマ定義 
  - [ ] エラーメッセージの定義

### 2. テキストエリアコンポーネント
- [ ] `diary/form/text-area.tsx`の作成
  - [ ] クライアントコンポーネントとして実装(`use client`)
  - [ ] shadcn/uiのTextareaコンポーネントの拡張
  - [ ] 最大500文字の入力制限実装
  - [ ] リアルタイム文字数カウント連携
  - [ ] 文字数超過時のバリデーション

### 3. 文字数カウントコンポーネント
- [ ] `diary/form/character-counter.tsx`の作成
  - [ ] 現在の文字数/最大文字数の表示
  - [ ] 残り文字数警告（50文字以下）
    - [ ] 警告アイコン表示（Lucideアイコン）
    - [ ] ツールチップ表示

### 4. 日付選択コンポーネント
- [ ] `diary/form/date-picker.tsx`の作成
  - [ ] react-day-pickerを使用したカレンダー実装
  - [ ] 日付選択機能の実装
  - [ ] 選択された日付の表示

### 5. Server Actions
- [ ] `diary/form/actions.ts`の作成
  - [ ] `"use server"`ディレクティブの使用
  - [ ] 日記エントリー保存アクション
  - [ ] Zodバリデーション処理
  - [ ] エラーハンドリング
  - [ ] 日付バリデーション（1日1エントリー制限）

### 6. Presentationalコンポーネント
- [ ] `diary/form/presentational.tsx`の作成
  - [ ] クライアントコンポーネントとして実装(`use client`)
  - [ ] テキストエリア、文字数カウント、日付選択の統合
  - [ ] フォームレイアウトの実装
  - [ ] 保存ボタンのUI実装
  - [ ] ローディング状態の表示
  - [ ] エラー表示

### 7. Containerコンポーネント
- [ ] `diary/form/container.tsx`の作成
  - [ ] Server Actionの統合
  - [ ] エラーハンドリング
  - [ ] 成功/エラー通知の実装（sonner使用）

### 8. エクスポート用ファイル
- [ ] `diary/form/index.tsx`の作成
  - [ ] ContainerコンポーネントとPresentationalコンポーネントの統合
  - [ ] 公開APIの定義

### 9. StoryBookの実装
- [ ] 各コンポーネントのStories作成
  - [ ] `text-area.stories.tsx`
  - [ ] `character-counter.stories.tsx`
  - [ ] `date-picker.stories.tsx`
  - [ ] `diary-form.stories.tsx`
- [ ] 各状態のシナリオ実装
  - [ ] 通常状態
  - [ ] 文字数制限超過状態
  - [ ] 文字数警告状態（50文字以下）
  - [ ] 保存中状態
  - [ ] エラー状態
- [ ] インタラクションテストの追加

## 技術的考慮事項

### 1. サーバーコンポーネントとクライアントコンポーネントの分離
- Containerコンポーネント: サーバーロジックを担当
- Presentationalコンポーネント: クライアントUI表示を担当

### 2. Server Actionsの使用
- `"use server"`ディレクティブを使用した関数実装
- Zodによる入力値のバリデーション
- Prismaを使用したデータ保存

### 3. エラーハンドリング
- バリデーションエラーの適切な表示
- サーバーエラーの適切な処理と表示
- ユーザーフレンドリーなエラーメッセージ

### 4. 状態管理
- フォーム入力値の管理（@conformを使用）
  - フォームスキーマの定義
  - バリデーションと状態管理の統合
  - 型安全なフォーム制御
- ローディング状態の管理
- エラー状態の管理

### 5. アクセシビリティ
- 適切なARIAラベルの設定
- キーボードナビゲーションのサポート
- エラー時のフォーカス管理

## 実装の優先順位
1. 型定義とバリデーション
2. テキストエリアと文字数カウント実装
3. 日付選択コンポーネント実装
4. Server Actions実装
5. Presentationalコンポーネント実装
6. Containerコンポーネント実装
7. StoryBook実装

## テスト計画
1. 各コンポーネントの単体テスト
2. フォーム入力と送信の統合テスト
3. バリデーションとエラー表示のテスト
4. Server Actionsのテスト

## リスクと対策
1. **Server Actionsの複雑さ**
   - 段階的な実装で複雑性を管理
   - エラーケースを先に考慮して実装

2. **フォームのパフォーマンス**
   - 文字入力時の過剰な再レンダリングを防止
   - メモ化を適切に使用

3. **バリデーションの一貫性**
   - クライアントとサーバーで同じバリデーションロジックを使用
   - Zodスキーマを一元管理

4. **@conformの学習曲線**
   - 公式ドキュメントとサンプルコードを参照
   - 小さなコンポーネントから段階的に実装

ステータス: [Active]
確信度: [95%]
最終更新日: 2024-06-05

## 日記一覧画面UI改善タスク

[ID-016] 日記一覧画面のUI改善
ステータス: [-] 優先度: [High]
依存関係: なし
進捗ノート:
- 2024-06-05 要件分析とタスク計画を作成
- 2024-06-05 コンポーネント実装完了

### タスク詳細

1. 月ナビゲーションコンポーネントの作成
   - [X] 既存の`MonthSelector`コンポーネントの分析
   - [X] 新しい`MonthNavigation`コンポーネントの実装
     - [X] 前月・次月ボタンの追加
     - [X] 中央に年月表示
     - [X] クリック時の月変更機能の実装

2. 日記追加ボタンの実装
   - [X] 位置固定のボタンコンポーネント実装
   - [X] `/diary/create`へのリンク設定
   - [X] スクロール時に位置が変わらない実装
   - [X] モバイル対応デザイン

### 実装計画

#### 1. MonthNavigationコンポーネント
- [X] 場所: `app/_components/features/diary/month-navigation.tsx`
- [X] タイプ: Clientコンポーネント
- [X] 機能:
  - [X] 前月/次月への移動ボタン
  - [X] 年月の表示（format関数使用）
  - [X] ユーザーが月を変更できる機能

#### 2. 日記追加ボタン（FloatingActionButton）
- [X] 場所: `app/_components/ui/floating-action-button.tsx`（汎用コンポーネント）
- [X] 実装:
  - [X] 右下に固定
  - [X] スクロールに影響されない位置固定
  - [X] モバイル対応

#### 3. 既存コードの変更
- [X] 場所: `app/_components/features/diary/monthly-diary-list.tsx`
- [X] 変更内容:
  - [X] `MonthSelector`を`MonthNavigation`に置き換え
  - [X] FloatingActionButtonの追加

### 技術的な考慮事項
- [X] MonthNavigationはdate-fnsを使用して日付操作
- [X] 前月/次月ボタンはLucideアイコンを使用
- [X] 位置固定ボタンはTailwind CSSのfixed positioningを使用
- [X] アクセシビリティを考慮した実装（適切なaria属性）

### 動作確認
- [ ] 前月・次月ボタンの動作確認
- [ ] 日付変更機能の確認
- [ ] 日記追加ボタンのクリック時に日記作成画面に遷移することを確認
- [ ] レスポンシブデザインの確認（モバイル・デスクトップ）
