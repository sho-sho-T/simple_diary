# このファイルの説明(編集不可)
このスクラッチパッドファイルは、タスク管理および実装計画のためのものです。
取り組むタスクにおける作業計画をチェックボックス形式で記述します。

- [X] = 完了 (100% 完了、検証済み)
- [-] = 進行中 (積極的に作業中)
- [ ] = 計画 (未開始)
- [!] = ブロック (依存関係あり)
- [?] = レビューが必要 (検証が必要)

# 作業計画(編集可)

ステータス: [Active]
確信度: [95%]
最終更新日: 2025-03-08

## 日記アプリケーション実装計画

### Phase 2: フロントエンド実装
[ID-004] 共通UIコンポーネント構築
- [X] レイアウトとナビゲーション
- [X] 日記エントリーカードコンポーネント
- [X] タグ表示・選択コンポーネント
- [X] 感情スタンプ選択コンポーネント
- [X] 基本的なUIライブラリのセットアップ (shadcn/ui)

[ID-005] マークダウンエディタ実装
- [ ] リアルタイムプレビュー機能
- [ ] ツールバーと基本的なマークダウン操作
- [ ] react-markdownの統合

## [ID-005] マークダウンエディタ実装 - 詳細計画

ステータス: [Planning]
確信度: [95%]
最終更新日: 2024-03-10

### タスク概要
マークダウン形式でテキストを編集できるエディタコンポーネントを実装し、リアルタイムプレビュー機能とツールバーを提供する。また、作成したコンポーネントにはStorybookを追加する。

### 主要機能
- リアルタイムプレビュー機能
- ツールバーと基本的なマークダウン操作
- react-markdownの統合
- Storybook統合

### 技術選定
- **react-markdown**: マークダウンをHTMLにレンダリングするため
- **Radix UI**: アクセシブルなUI要素のため
- **shadcn/ui**: 既存UIコンポーネントとの統合
- **Tailwind CSS**: スタイリング
- **Conform** (`@conform-to/react`, `@conform-to/zod`): フォーム状態管理とバリデーション
- **Zod**: スキーマ定義とバリデーション

### 実装ステップ
1. **基本構造の実装**
   - [ ] `components/features/markdown/markdown-editor.tsx`: メインのエディタコンポーネント
   - [ ] `components/features/markdown/markdown-preview.tsx`: プレビュー表示コンポーネント
   - [ ] `components/features/markdown/markdown-toolbar.tsx`: ツールバーコンポーネント
   - [ ] `components/conform/`: Conformとshadcn/ui統合用コンポーネント

2. **機能実装**
   - [ ] Conformを使用したマークダウンテキスト入力機能の実装
   - [ ] Zodによるマークダウン内容の検証
   - [ ] react-markdownを使用したプレビュー機能
   - [ ] テキスト選択に基づくツールバー操作（太字、斜体、リスト等）
   - [ ] マークダウンコンテンツの保存と読み込み機能

3. **UIの統合とスタイリング**
   - [ ] shadcn/uiコンポーネントとConformの統合
   - [ ] レスポンシブデザインの実装
   - [ ] ダークモード対応

4. **Storybook実装**
   - [ ] `stories/components/markdown-editor.stories.tsx`: エディタのStory
   - [ ] `stories/components/markdown-preview.stories.tsx`: プレビューのStory
   - [ ] `stories/components/markdown-toolbar.stories.tsx`: ツールバーのStory
   - [ ] 各状態（空の状態、テキスト入力済み、エラー状態など）のストーリーバリエーション

### テスト計画
- 各コンポーネントの単体テスト
- マークダウンの変換機能のテスト
- ツールバー操作のテスト
- Conformによるバリデーションのテスト
- エッジケースの検証（大きなテキスト、特殊文字など）

### 潜在的な課題と対応策
- **パフォーマンスの問題**: 大きなマークダウンファイルでのリアルタイムレンダリングが遅くなる可能性
  → デバウンスを実装し、react-markdownの最適化設定を活用

- **UIの一貫性**: 既存UIとの統合における見た目の一貫性
  → shadcn/uiコンポーネントを最大限活用し、デザインシステムに従う

- **Conformの学習曲線**: チームメンバーがConformに慣れていない可能性
  → 十分なドキュメントとサンプルコードを提供

- **アクセシビリティ**: キーボードショートカットとスクリーンリーダー対応
  → Conformのアクセシビリティ機能を活用し、WAI-ARIAガイドラインに従う

### 依存関係
- [ID-004]の共通UIコンポーネント構築が完了していること

### 予想工数
- 基本実装: 4-6時間
- Conform統合: 2-3時間
- Storybook統合: 2-3時間
- テストとバグ修正: 2-3時間

[ID-006] カレンダーと日記表示画面
- [ ] 月間カレンダーの実装 (react-day-picker)
- [ ] 日付選択時の日記表示
- [ ] 過去の同日日記表示機能

[ID-007] 日記作成・編集フォーム
- [ ] 日記テキスト入力部分
- [ ] タグ選択・作成機能
- [ ] 感情スタンプ選択機能
- [ ] Zodバリデーション統合

### Phase 3: 認証と権限管理
[ID-008] Next Auth認証統合
- [ ] ログイン/ログアウト機能
- [ ] セッション管理
- [ ] 認証状態によるUI適応
- [ ] 保護されたルートの設定

### Phase 4: 追加機能実装
[ID-009] タグ検索・フィルタリング機能
- [ ] タグベースの日記フィルタリング
- [ ] タグクラウド/タグリスト表示
- [ ] タグ管理インターフェース

[ID-010] 感情スタンプの可視化
- [ ] 感情スタンプの時系列分析
- [ ] カレンダーでの感情表示

### Phase 5: 最適化とテスト
[ID-011] パフォーマンス最適化
- [ ] サーバーコンポーネントとクライアントコンポーネントの適切な使い分け
- [ ] データフェッチ最適化
- [ ] レンダリング戦略の改善

[ID-012] テストとバグ修正
- [ ] 単体テスト作成
- [ ] E2Eテスト作成
- [ ] エッジケースの検証

[ID-014] StoryBookの実装
- [ ] UIコンポーネント用のStories作成
- [ ] レイアウトコンポーネント用のStories作成
- [ ] 機能コンポーネント用のStories作成
- [ ] StoryBook実行環境のカスタマイズ
- [ ] テスト連携の設定

## 実装方法詳細（Next.jsベストプラクティス準拠）

### サーバーコンポーネントとクライアントコンポーネントの使い分け
- データフェッチはサーバーコンポーネントで行う
- ユーザーインタラクションが必要な部分のみクライアントコンポーネントを使用
- コンポジションパターンを活用し、サーバーコンポーネントをクライアントコンポーネントに渡す

### データフェッチ層の設計
- データフェッチ処理を`_lib`ディレクトリに集約
- 処理の再利用性とコロケーションのバランスを確保
- `server-only`パッケージによるクライアントでの使用防止

### API実装のアプローチ
- Route Handlersとともに、Server Actionsを活用
- 細粒度のREST API設計を採用
- レスポンスの適切なキャッシュ設定

### エラーハンドリング
- サーバーコンポーネント: `error.tsx`でのエラーUI定義
- ServerActions: 予測可能なエラーは戻り値で表現
- フロントエンド: Toastなどを使用したユーザーフレンドリーなエラー表示

### セキュリティと認証
- 認証状態の確認と適切なエラーレスポンス
- URLベースの認可とデータアクセスベースの認可の両方を実装
- CSRF対策の実装

## 技術的な考慮事項と注意点

### データベース関連
- Prismaスキーマ変更後は必ずマイグレーションコマンドを実行すること
- 推奨コマンド: `npx prisma db push` または `npx prisma migrate dev --name xxx`
- エラー発生時は `npx prisma migrate dev --create-only` と `npx prisma migrate deploy` の組み合わせを試す

### 実装ガイドライン
- バリデーション: Zodを使用
- エラーハンドリング: グローバルエラーハンドリング
- パフォーマンス: サーバーコンポーネントでデータフェッチを行う
- レスポンシブデザイン: モバイルファースト
- shadcn/uiコンポーネントを活用

### 制約条件
- タグ削除時、使用中のタグは削除不可
- 日記は日付ごとに1エントリーのみ
- エラーケースの適切なハンドリング

## 技術的考慮事項

### コンポーネントタイプ別の対応
- サーバーコンポーネント: サーバーコンポーネントの場合、必要に応じてStoriesでクライアントコンポーネントとしてラップ
- クライアントコンポーネント: 'use client'ディレクティブがあるコンポーネントについては、そのままStoryBookで表示可能
- 状態管理が必要なコンポーネント: 必要なコンテキストプロバイダーをdecoratorsで提供

### 特殊なケース
- フォーム関連コンポーネント: react-hook-formとの連携を考慮したストーリー設計
- API依存コンポーネント: MSWなどを使用したモックAPIレスポンスの提供

### ドキュメント化
- コンポーネントのJSDocコメントを活用したドキュメント自動生成
- argTypesでの適切な説明とコントロール設定
- MDXファイルによる追加の使用方法ドキュメント作成

## 成功基準
- 全ての対象コンポーネントについてStoryBookストーリーが作成されている
- コンポーネントの主要な機能と状態がストーリーでカバーされている
- StoryBookが正常に起動し、すべてのストーリーが適切に表示される
- チーム内でStoryBookをコンポーネント開発とレビューに活用できる

## リスクと軽減策
- 一部の高度な機能コンポーネントでモックデータ作成が複雑になる可能性 → 段階的に実装し、最初はシンプルなケースから対応
- サーバーコンポーネントのStoryBook対応の複雑さ → 必要に応じてStoryBook専用のラッパーコンポーネントを作成
- ビルド時間の増加 → StoryBookの設定を最適化し、必要に応じてストーリーをカテゴリ別に分離

# 緊急バグ修正タスク

ステータス: [Active]
確信度: [95%]
最終更新日: 2024-06-03

## エラー詳細
```
You cannot use different slug names for the same dynamic path ('date' !== 'id').
```

## 問題分析
Next.jsのAPI Routes設計において、同じパスパターンに対して異なるスラグ名を使用することはできません。現在の実装では：

1. `/api/diary/[date]/route.ts` - 特定日付の日記エントリー取得
2. `/api/diary/[id]/route.ts` - 日記エントリーの更新・削除

これらは同じパスパターン（`/api/diary/[パラメータ]`）に異なるスラグ名（`date`と`id`）を使用しているため、Next.jsのルーティングエンジンで競合が発生しています。

## 解決策候補

[ID-013] APIルーティング競合の解決
- [X] 異なるパスパターンを使用するようにルートを再設計
  - 案1: 日付ベースのルートを `/api/diary/by-date/[date]` に変更
  - 案2: ID ベースのルートを `/api/diary/by-id/[id]` に変更
  - 案3: 日付ベースのルートは日付のフォーマットを強制して一般的なIDと重複しないようにする（例: `YYYY-MM-DD`形式）
- [X] ルートファイルの移動と内容の調整
  - 影響するファイルの特定とバックアップ
  - 新しいディレクトリ構造の作成
  - ルートハンドラとサービス関数の接続の更新
- [X] リファクタリング後のテスト
  - 各エンドポイントのテスト
  - エラーケースのテスト
  - 期待通りのレスポンスが返されることの確認

## 技術的考慮事項
- Next.jsのルーティングルールに従って実装する
- memories.mdに記録されているAPIベストプラクティスを適用する
- リファクタリングにおいてはサービス層の実装は変更せず、ルートハンドラのみを変更する

## 優先度と影響範囲
- 優先度: 高（アプリケーションのビルドに影響するバグ）
- 影響範囲: 限定的（API実装の一部のみに影響）
- 対応工数見積: 約1時間（確認とテスト含む）

## 実装計画
1. 日付ベースのルートを `/api/diary/by-date/[date]` に変更する（案1を採用）✅
2. 必要なディレクトリ構造を作成し、ファイルを移動 ✅
3. インポートパスなど、必要に応じてコードを調整 ✅
4. 各エンドポイントのテストを実行 ✅
5. スクラッチパッドを更新して進捗を記録 ✅

## 実装結果
- 日付ベースのルートを `/api/diary/by-date/[date]` に変更し、競合を解消
- 絶対パス（`@/`エイリアス）を使用してインポートパスを修正
- 古いルートファイルとディレクトリを削除
- バグが解決し、アプリケーションが正常にビルドされるようになった